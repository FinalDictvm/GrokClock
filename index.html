<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grok Clock with Zoom and Pan</title>
  <style>
    body {
      background: #333;
      font-family: sans-serif;
      text-align: center;
      color: white;
      position: relative;
    }
    #previewWindow {
      position: absolute;
      top: 360px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2em;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
      pointer-events: none;
    }
    #previewWindow .event-date {
      font-size: 0.6em;
    }
    #previewWindow .event-date .to {
      color: gray;
    }
    .clock-container {
      position: relative;
      width: 320px;
      height: 320px;
      margin: 50px auto;
    }
    .clock {
      width: 300px;
      height: 300px;
      border: 10px solid #807466;
      border-radius: 50%;
      position: absolute;
      top: 0;
      left: 0;
      background: #e0d9d1;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.4),
                  inset -0.5px 0.5px 5px rgba(0, 0, 0, 0.3);
      filter: drop-shadow(-5px 10px 8px rgba(0, 0, 0, 0.2));
      z-index: 2;
      overflow: hidden; /* To clip the scaled content */
    }
    #clockFace {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      transform-origin: 50% 50%;
    }
    .day-ticks-container {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 0;
    }
    .season-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      pointer-events: none;
      z-index: 2;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      background: conic-gradient(
        rgba(255,72,0,0.4) 0deg, rgba(255,72,0,0.4) 18deg,
        rgba(59,160,255,0.5) 22deg, rgba(168,255,249,0.8) 107deg,
        rgba(51,245,177,0.7) 111deg, rgba(117,255,48,0.5) 198deg,
        rgba(255,255,112,0.8) 202deg, rgba(255,225,36,0.5) 290deg,
        rgba(255,165,0,0.5) 294deg, rgba(255,72,0,0.4) 360deg
      );
    }
    .arcs {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 3;
      overflow: visible;
    }
    .arcs path {
      transition: stroke-width 0.2s ease, d 0.3s ease;
    }
    .month {
      position: absolute;
      width: 40px;
      text-align: center;
      font-size: 0.9em;
      font-weight: bold;
      z-index: 3;
      text-shadow: 0 0 10px rgba(255,255,255,1),
                   -2px 2px 2px rgba(0,0,0,0.4);
    }
    .month-tick {
      position: absolute;
      width: 2px;
      height: 6px;
      background: #807466;
      transform-origin: left center;
      z-index: 3;
      box-shadow: 0 1px 2px rgba(0,0,0,0.4);
    }
    .day-tick {
      position: absolute;
      width: 1px;
      background: #ADD8E6;
      opacity: 0.4;
      z-index: 0;
      transform: scaleY(0.83);
      transition: transform 0.15s ease-in-out;
    }
    .day-tick.first {
      background: #00FF00;
      height: 20px;
      width: 2px;
      opacity: 1;
    }
    .day-tick.even {
      height: 4px;
    }
    .day-tick.odd {
      background: white;
      height: 7px;
      opacity: 0.7;
    }
    .day-tick.fifteenth {
      height: 16px;
      opacity: 0.75;
    }
    .day-tick.last-odd {
      background: white;
      height: 16px;
      opacity: 1;
    }
    .hand {
      width: 4px;
      height: 120px;
      background: white;
      position: absolute;
      left: calc(50% - 2px);
      bottom: 150px;
      transform-origin: bottom center;
      transform: rotate(0deg);
      transition: transform 0.5s linear;
      z-index: 3;
      box-shadow: 0 2px 3px rgba(0,0,0,0.3);
    }
    .pointer {
      width: 1px;
      height: 10px;
      background: white;
      position: absolute;
      left: calc(50% - 0.5px);
      top: -40px;
      transform-origin: bottom center;
      z-index: 3;
      display: block;
      box-shadow: 0 0 1px rgba(0,0,0,0.8);
    }
    .hour-hand {
      width: 4px;
      height: 80px;
      background: #333;
      position: absolute;
      left: calc(50% - 2px);
      bottom: 150px;
      transform-origin: bottom center;
      transform: rotate(0deg);
      z-index: 3;
      box-shadow: 0 2px 3px rgba(0,0,0,0.3);
      display: none;
    }
    .minute-hand {
      width: 3px;
      height: 100px;
      background: #666;
      position: absolute;
      left: calc(50% - 1.5px);
      bottom: 150px;
      transform-origin: bottom center;
      transform: rotate(0deg);
      z-index: 3;
      box-shadow: 0 2px 3px rgba(0,0,0,0.3);
      display: none;
    }
    .second-hand {
      width: 1px;
      height: 110px;
      background: red;
      position: absolute;
      left: calc(50% - 0.5px);
      bottom: 150px;
      transform-origin: bottom center;
      transform: rotate(0deg);
      z-index: 3;
      box-shadow: 0 2px 3px rgba(0,0,0,0.3);
      display: none;
    }
    .center {
      width: 10px;
      height: 10px;
      background: #d6c7c3;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 4;
      box-shadow: -0.5px 2px 4px rgba(0,0,0,0.4),
                  inset 2px -2px 5px rgba(0,0,0,0.7);
    }
    .marker {
      position: absolute;
      width: 20px;
      height: 20px;
      background: transparent;
      z-index: 5;
      cursor: pointer;
      display: none;
      transition: left 0.3s ease, top 0.3s ease;
    }
    .major-holiday-dot,
    .minor-holiday-dot,
    .birthday-dot,
    .custom-dot,
    .life-dot {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 4px;
      height: 4px;
      border-radius: 50%;
      border: 1px solid white;
      transition: transform 0.2s ease;
    }
    .major-holiday-dot { background: rgb(255, 0, 0); }
    .minor-holiday-dot { background: rgb(255, 165, 0); }
    .birthday-dot { background: rgb(255, 8, 201); }
    .custom-dot { background: rgb(4, 255, 0); }
    .life-dot { background: rgb(13, 126, 255); }
    .active .major-holiday-dot,
    .active .minor-holiday-dot,
    .active .birthday-dot,
    .active .custom-dot,
    .active .life-dot {
      transform: translate(-50%, -50%) scale(2);
    }
    .event-label {
      position: absolute;
      white-space: nowrap;
      font-size: 0.7em;
      color: white;
      z-index: 6;
      cursor: move;
      user-select: none;
      line-height: 1;
    }
    .connector {
      position: absolute;
      height: 1px;
      transform-origin: 0 50%;
      pointer-events: none;
      z-index: 6;
    }
    .controls {
      margin-top: 105px;
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 20px;
      width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .controls-column {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      width: 200px;
    }
    .controls-column.more-options {
      display: none;
    }
    .checkbox-label {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      font-size: 0.9em;
      color: #D3D3D3;
      cursor: pointer;
      width: 100%;
      max-width: 200px;
    }
    .checkbox-label input[type="checkbox"] {
      display: none;
    }
    .checkbox-label .checkbox-custom {
      width: 16px;
      height: 16px;
      border: 2px solid #807466;
      background: #e0d9d1;
      margin-left: 8px;
      position: relative;
      transition: background 0.2s ease;
    }
    .checkbox-label input[type="checkbox"]:checked + .checkbox-custom {
      background: #807466;
    }
    .checkbox-label input[type="checkbox"]:checked + .checkbox-custom::after {
      content: "X";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      font-weight: bold;
    }
    #toggleMajorHolidays:checked + .checkbox-custom::after { color: rgb(255, 0, 0); }
    #toggleMinorHolidays:checked + .checkbox-custom::after { color: rgb(255, 165, 0); }
    #toggleBirthdays:checked + .checkbox-custom::after { color: rgb(255, 8, 201); }
    #toggleLifeEvents:checked + .checkbox-custom::after { color: rgb(13, 126, 255); }
    #toggleCustomEvents:checked + .checkbox-custom::after { color: rgb(4, 255, 0); }
    #toggleSeasons:checked + .checkbox-custom::after,
    #toggleTemperatures:checked + .checkbox-custom::after,
    #toggleClockHands:checked + .checkbox-custom::after,
    #toggleDayTicks:checked + .checkbox-custom::after,
    #toggleFPS:checked + .checkbox-custom::after,
    #togglePointer:checked + .checkbox-custom::after,
    #togglePreviewAllDates:checked + .checkbox-custom::after { color: white; }
    #toggleCustomEventsLabel {
      display: none;
    }
    .custom-event-button {
      width: 300px;
      margin-left: auto;
      margin-right: auto;
      margin-top: 19px;
      text-align: center;
    }
    #addCustomEvent, #toggleMoreOptions {
      padding: 3px 6px;
      font-size: 0.7em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #807466;
      color: white;
      box-shadow: 0 2px 3px rgba(0,0,0,0.3);
      margin: 5px 0;
    }
    @keyframes rippleIn {
      0% { transform: scale(0.5); opacity: 0; }
      40% { transform: scale(2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes rippleOut {
      0% { transform: scale(1); opacity: 1; }
      60% { transform: scale(0.2); opacity: 0.8; }
      100% { transform: scale(0); opacity: 0; }
    }
    .ripple-in { animation: rippleIn 0.3s forwards; }
    .ripple-out { animation: rippleOut 0.3s forwards; }
    .temperature {
      font-size: 0.8em;
      color: white;
      opacity: 0;
      transition: opacity 0.45s ease-in-out;
      position: absolute;
      z-index: 3;
      pointer-events: none;
      text-shadow: 0 0 5px rgba(0,0,0,1);
    }
    .temperature.visible {
      opacity: 0.6;
    }
    .temperature.march.visible { opacity: 0.75; }
    .temperature.may.visible { opacity: 0.7; }
    .temperature.june.visible { opacity: 0.8; }
    .temperature.july.visible { opacity: 1.0; }
    .temperature.august.visible { opacity: 0.95; }
    .temperature.september.visible { opacity: 0.85; }
    .date-preview {
      position: absolute;
      left: 50%;
      top: 63%;
      transform: translateX(-50%);
      font-size: 0.9em;
      color: white;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
      z-index: 3;
      pointer-events: none;
      text-shadow: 0 0 10px rgba(0,0,0,1);
    }
    .date-preview.visible {
      opacity: 1;
    }
    #fpsDisplay {
      position: fixed;
      top: 10px;
      left: 10px;
      font-size: 1em;
      color: white;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px;
      border-radius: 3px;
      display: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="fpsDisplay">FPS: 0</div>
  <div class="clock-container">
    <div class="day-ticks-container" id="dayTicksContainer"></div>
    <div class="clock" id="clock">
      <div class="season-overlay" id="seasonOverlay"></div>
      <svg class="arcs" width="300" height="300" viewBox="0 0 300 300"></svg>
      <div class="hand" id="hand">
        <div class="pointer" id="pointer"></div>
      </div>
      <div class="hour-hand" id="hourHand"></div>
      <div class="minute-hand" id="minuteHand"></div>
      <div class="second-hand" id="secondHand"></div>
      <div class="center"></div>
      <div class="date-preview" id="datePreview"></div>
    </div>
  </div>
  <div id="previewWindow"></div>
  <div class="controls">
    <div class="controls-column always-visible">
      <label class="checkbox-label">
        Life Events
        <input type="checkbox" id="toggleLifeEvents">
        <span class="checkbox-custom"></span>
      </label>
      <label class="checkbox-label">
        Birthdays
        <input type="checkbox" id="toggleBirthdays">
        <span class="checkbox-custom"></span>
      </label>
      <label class="checkbox-label">
        Major Holidays
        <input type="checkbox" id="toggleMajorHolidays">
        <span class="checkbox-custom"></span>
      </label>
      <label class="checkbox-label">
        Seasons
        <input type="checkbox" id="toggleSeasons">
        <span class="checkbox-custom"></span>
      </label>
      <label class="checkbox-label">
        Day Ticks
        <input type="checkbox" id="toggleDayTicks">
        <span class="checkbox-custom"></span>
      </label>
      <label class="checkbox-label">
        Preview All Dates
        <input type="checkbox" id="togglePreviewAllDates">
        <span class="checkbox-custom"></span>
      </label>
      <label class="checkbox-label" id="toggleCustomEventsLabel">
        Custom Events
        <input type="checkbox" id="toggleCustomEvents">
        <span class="checkbox-custom"></span>
      </label>
    </div>
    <div class="controls-column more-options">
      <label class="checkbox-label">
        Minor Holidays
        <input type="checkbox" id="toggleMinorHolidays">
        <span class="checkbox-custom"></span>
      </label>
      <label class="checkbox-label">
        Temperatures
        <input type="checkbox" id="toggleTemperatures">
        <span class="checkbox-custom"></span>
      </label>
      <label class="checkbox-label">
        Clock Hands
        <input type="checkbox" id="toggleClockHands">
        <span class="checkbox-custom"></span>
      </label>
      <label class="checkbox-label">
        FPS
        <input type="checkbox" id="toggleFPS">
        <span class="checkbox-custom"></span>
      </label>
      <label class="checkbox-label">
        Pointer
        <input type="checkbox" id="togglePointer" checked>
        <span class="checkbox-custom"></span>
      </label>
    </div>
  </div>
  <div class="custom-event-button">
    <button id="addCustomEvent">Add Custom Event</button>
    <button id="toggleMoreOptions">More Options</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const clock = document.getElementById("clock");
      const dayTicksContainer = document.getElementById("dayTicksContainer");
      const seasonOverlay = document.getElementById("seasonOverlay");
      const pointer = document.getElementById("pointer");
      const hand = document.getElementById("hand");
      const datePreview = document.getElementById("datePreview");
      const previewWindow = document.getElementById("previewWindow");
      const fpsDisplay = document.getElementById("fpsDisplay");
      const moreOptionsColumn = document.querySelector(".controls-column.more-options");
      const toggleMoreOptionsButton = document.getElementById("toggleMoreOptions");
      const addCustomEventButton = document.getElementById("addCustomEvent");
      let moreOptionsVisible = false;
      const centerX = 160, centerY = 160;
      const triggerRadius = 15;
      const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      const averageTemps = [30, 35, 45, 55, 65, 75, 80, 78, 70, 60, 50, 35];
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const temperatureElements = [];
      const dayTickElements = [];
      const events = new Map();
      let eventCounter = 0;
      const hoveredDates = new Set();

      const typePriority = ["major-holiday", "minor-holiday", "birthday", "life", "custom"];
      const visibilityMap = {
        "major-holiday": false,
        "minor-holiday": false,
        "birthday": false,
        "life": false,
        "custom": false,
        "pointer": true,
        "dayTicks": false,
        "fps": false,
        "previewAllDates": false
      };

      pointer.style.display = visibilityMap["pointer"] ? "block" : "none";

      // Create clockFace div to handle zoom and pan
      const clockFace = document.createElement('div');
      clockFace.id = 'clockFace';
      clockFace.style.position = 'absolute';
      clockFace.style.left = '0px';
      clockFace.style.top = '0px';
      clockFace.style.width = '100%';
      clockFace.style.height = '100%';
      clockFace.style.transformOrigin = '50% 50%';
      while (clock.firstChild) {
        clockFace.appendChild(clock.firstChild);
      }
      clock.appendChild(clockFace);

      // Move dayTicksContainer inside clockFace for consistent scaling
      clockFace.appendChild(dayTicksContainer);

      // Initialize zoom and pan variables
      let z = 1; // Zoom scale
      let panX = 0; // X offset in pixels
      let panY = 0; // Y offset in pixels
      let isPanning = false;
      let startMouseX, startMouseY, startPanX, startPanY;

      // Clock setup: Months and temperature markers
      months.forEach((month, index) => {
        const marker = document.createElement("div");
        marker.className = "month";
        marker.innerText = month;
        marker.style.color = ([3,6,9,12].includes(index + 1)) ? "red" : "black";
        marker.style.fontSize = ([3,6,9,12].includes(index + 1)) ? "1.0em" : "0.9em";
        const angle = index * 30 + 30;
        const radian = (angle - 90) * Math.PI / 180;
        const radiusMarker = 130;
        marker.style.left = (centerX - 10 + radiusMarker * Math.cos(radian) - 20) + "px";
        marker.style.top = (centerY - 10 + radiusMarker * Math.sin(radian) - 10) + "px";
        clockFace.appendChild(marker);

        const monthTick = document.createElement("div");
        monthTick.className = "month-tick";
        const radiusTick = 150;
        const tickX = centerX - 10 + radiusTick * Math.cos(radian);
        const tickY = centerY - 10 + radiusTick * Math.sin(radian);
        monthTick.style.left = (tickX - 1) + "px";
        monthTick.style.top = tickY + "px";
        monthTick.style.transformOrigin = "center 3px";
        monthTick.style.transform = "translateY(-3px) rotate(" + angle + "deg)";
        clockFace.appendChild(monthTick);

        const temp = document.createElement("div");
        temp.className = "temperature";
        if (index + 1 === 3) temp.classList.add("march");
        if (index + 1 === 5) temp.classList.add("may");
        if (index + 1 === 6) temp.classList.add("june");
        if (index + 1 === 7) temp.classList.add("july");
        if (index + 1 === 8) temp.classList.add("august");
        if (index + 1 === 9) temp.classList.add("september");
        temp.innerText = averageTemps[index] + "°F";
        const radiusTemp = 98;
        const tempAngle = index * 30 + 45;
        const tempRadian = (tempAngle - 90) * Math.PI / 180;
        temp.style.left = (centerX - 10 + radiusTemp * Math.cos(tempRadian)) + "px";
        temp.style.top = (centerY - 10 + radiusTemp * Math.sin(tempRadian)) + "px";
        temp.style.transform = "translate(-50%, -50%)";
        temperatureElements.push(temp);
        clockFace.appendChild(temp);
      });

      // Day Ticks setup (365 ticks for 2025, non-leap year)
      const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
      let dayCounter = 0;
      const fragment = document.createDocumentFragment();
      daysInMonth.forEach((days, month) => {
        for (let day = 1; day <= days; day++) {
          const totalDays = daysInMonth[month];
          const fraction = (day - 1) / totalDays;
          const angle = (month + fraction + 1) * 30;
          const tick = document.createElement("div");
          tick.className = "day-tick";
          if (day === 1) {
            tick.classList.add("first");
          } else if (day === days && day % 2 !== 0) {
            tick.classList.add("last-odd");
          } else if (day % 2 === 0) {
            tick.classList.add("even");
          } else {
            tick.classList.add("odd");
          }
          if (day === 15 && day !== 1) {
            tick.classList.add("fifteenth");
          }
          tick.dataset.angle = angle;
          tick.dataset.dayIndex = dayCounter;
          fragment.appendChild(tick);
          dayCounter++;
        }
      });
      dayTicksContainer.appendChild(fragment);

      // Position day ticks
      const ticks = dayTicksContainer.querySelectorAll('.day-tick');
      ticks.forEach(tick => {
        const computedStyle = window.getComputedStyle(tick);
        const visibleHeight = parseFloat(computedStyle.height);
        const width = parseFloat(computedStyle.width);
        const totalHeight = 170 + visibleHeight;
        tick.style.height = totalHeight + 'px';
        tick.style.left = (160 - width / 2) + 'px';
        tick.style.top = (160 - totalHeight) + 'px';
        tick.style.transformOrigin = 'bottom center';
        const angle = parseFloat(tick.dataset.angle);
        tick.style.transform = `rotate(${angle}deg) scaleY(0.83) translateZ(0)`;
        dayTickElements.push(tick);
      });

      // FPS setup
      let lastTime = performance.now();
      let frameCount = 0;
      let fps = 0;
      function updateFPS() {
        if (!visibilityMap["fps"]) return;
        frameCount++;
        const currentTime = performance.now();
        const delta = (currentTime - lastTime) / 1000;
        if (delta >= 1) {
          fps = frameCount / delta;
          fpsDisplay.textContent = `FPS: ${Math.round(fps)}`;
          frameCount = 0;
          lastTime = currentTime;
        }
        requestAnimationFrame(updateFPS);
      }

      // Utility functions
      function getDaySuffix(day) {
        if (day >= 11 && day <= 13) return "th";
        switch(day % 10) {
          case 1: return "st";
          case 2: return "nd";
          case 3: return "rd";
          default: return "th";
        }
      }

      function formatDate(month, day) {
        return monthNames[month - 1] + " " + day + getDaySuffix(day);
      }

      function nthWeekdayOfMonth(year, month, weekday, n) {
        const firstDay = new Date(year, month - 1, 1);
        const firstWeekday = firstDay.getDay();
        const offset = (weekday - firstWeekday + 7) % 7;
        return 1 + offset + (n - 1) * 7;
      }

      function lastWeekdayOfMonth(year, month, weekday) {
        const lastDay = new Date(year, month, 0).getDate();
        const date = new Date(year, month - 1, lastDay);
        while (date.getDay() !== weekday) {
          date.setDate(date.getDate() - 1);
        }
        return date.getDate();
      }

      function easterSunday(year) {
        const a = year % 19;
        const b = Math.floor(year / 100);
        const c = year % 100;
        const d = Math.floor(b / 4);
        const e = b % 4;
        const f = Math.floor((b + 8) / 25);
        const g = Math.floor((b - f + 1) / 3);
        const h = (19 * a + b - d - g + 15) % 30;
        const i = Math.floor(c / 4);
        const k = c % 4;
        const l = (32 + 2 * e + 2 * i - h - k) % 7;
        const m = Math.floor((a + 11 * h + 22 * l) / 451);
        const month = Math.floor((h + l - 7 * m + 114) / 31);
        const day = ((h + l - 7 * m + 114) % 31) + 1;
        return { month: month, day: day };
      }

      function getNextHolidayDate(name, year, month, day, calcFunc) {
        const today = new Date();
        let holidayYear = today.getFullYear();
        let holidayMonth, holidayDay;
        if (calcFunc) {
          const result = calcFunc(holidayYear);
          holidayMonth = result.month;
          holidayDay = result.day;
        } else {
          holidayMonth = month;
          holidayDay = day;
        }
        const holidayDate = new Date(holidayYear, holidayMonth - 1, holidayDay);
        if (holidayDate <= today) {
          holidayYear++;
          if (calcFunc) {
            const result = calcFunc(holidayYear);
            holidayMonth = result.month;
            holidayDay = result.day;
          }
        }
        return { name: name, month: holidayMonth, day: holidayDay };
      }

      // Clock hands update
      function updateHands() {
        const now = new Date();
        const monthIndex = now.getMonth() + 1;
        const totalDays = new Date(now.getFullYear(), monthIndex, 0).getDate();
        const secondsInDay = 86400;
        const secondsPassedToday = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const fractionToday = secondsPassedToday / secondsInDay;
        const fractionMonth = (now.getDate() - 1 + fractionToday) / totalDays;
        const monthAngle = (monthIndex - 1 + fractionMonth + 1) * 30;

        hand.style.transform = `rotate(${monthAngle}deg)`;

        const hours = now.getHours() + now.getMinutes() / 60;
        const hourAngle = (hours % 12) * 30;
        const hourHand = document.getElementById("hourHand");
        if (hourHand) hourHand.style.transform = `rotate(${hourAngle}deg)`;

        const minutes = now.getMinutes() + now.getSeconds() / 60;
        const minuteAngle = minutes * 6;
        const minuteHand = document.getElementById("minuteHand");
        if (minuteHand) minuteHand.style.transform = `rotate(${minuteAngle}deg)`;

        const seconds = now.getSeconds();
        const secondAngle = seconds * 6;
        const secondHand = document.getElementById("secondHand");
        if (secondHand) secondHand.style.transform = `rotate(${secondAngle}deg)`;
      }

      updateHands();
      setInterval(updateHands, 1000);

      // Event listeners for controls
      const toggleMajorHolidays = document.getElementById("toggleMajorHolidays");
      if (toggleMajorHolidays) {
        toggleMajorHolidays.addEventListener("change", function() {
          visibilityMap["major-holiday"] = this.checked;
          const markers = clockFace.querySelectorAll(".major-holiday-marker");
          const newlyVisible = [];
          markers.forEach(marker => {
            if (this.checked && marker.dataset.labelVisible !== "true") {
              marker.style.left = marker.dataset.baseLeft;
              marker.style.top = marker.dataset.baseTop;
              marker.style.display = "block";
              marker.classList.add("ripple-in");
              newlyVisible.push(marker);
              setTimeout(() => marker.classList.remove("ripple-in"), 300);
            } else if (!this.checked && marker.dataset.labelVisible !== "true") {
              marker.classList.add("ripple-out");
              setTimeout(() => {
                marker.classList.remove("ripple-out");
                marker.style.display = "none";
              }, 300);
            }
          });
          setTimeout(() => updateAllDotPositions(), newlyVisible.length ? 300 : 0);
        });
      }

      const toggleMinorHolidays = document.getElementById("toggleMinorHolidays");
      if (toggleMinorHolidays) {
        toggleMinorHolidays.addEventListener("change", function() {
          visibilityMap["minor-holiday"] = this.checked;
          const markers = clockFace.querySelectorAll(".minor-holiday-marker");
          const newlyVisible = [];
          markers.forEach(marker => {
            if (this.checked && marker.dataset.labelVisible !== "true") {
              marker.style.left = marker.dataset.baseLeft;
              marker.style.top = marker.dataset.baseTop;
              marker.style.display = "block";
              marker.classList.add("ripple-in");
              newlyVisible.push(marker);
              setTimeout(() => marker.classList.remove("ripple-in"), 300);
            } else if (!this.checked && marker.dataset.labelVisible !== "true") {
              marker.classList.add("ripple-out");
              setTimeout(() => {
                marker.classList.remove("ripple-out");
                marker.style.display = "none";
              }, 300);
            }
          });
          setTimeout(() => updateAllDotPositions(), newlyVisible.length ? 300 : 0);
        });
      }

      const toggleBirthdays = document.getElementById("toggleBirthdays");
      if (toggleBirthdays) {
        toggleBirthdays.addEventListener("change", function() {
          visibilityMap["birthday"] = this.checked;
          const markers = clockFace.querySelectorAll(".birthday-marker");
          const newlyVisible = [];
          markers.forEach(marker => {
            if (this.checked && marker.dataset.labelVisible !== "true") {
              marker.style.left = marker.dataset.baseLeft;
              marker.style.top = marker.dataset.baseTop;
              marker.style.display = "block";
              marker.classList.add("ripple-in");
              newlyVisible.push(marker);
              setTimeout(() => marker.classList.remove("ripple-in"), 300);
            } else if (!this.checked && marker.dataset.labelVisible !== "true") {
              marker.classList.add("ripple-out");
              setTimeout(() => {
                marker.classList.remove("ripple-out");
                marker.style.display = "none";
              }, 300);
            }
          });
          setTimeout(() => updateAllDotPositions(), newlyVisible.length ? 300 : 0);
        });
      }

      const toggleLifeEvents = document.getElementById("toggleLifeEvents");
      if (toggleLifeEvents) {
        toggleLifeEvents.addEventListener("change", function() {
          visibilityMap["life"] = this.checked;
          const markers = clockFace.querySelectorAll(".life-marker");
          const newlyVisible = [];
          markers.forEach(marker => {
            if (this.checked && marker.dataset.labelVisible !== "true") {
              marker.style.left = marker.dataset.baseLeft;
              marker.style.top = marker.dataset.baseTop;
              marker.style.display = "block";
              marker.classList.add("ripple-in");
              newlyVisible.push(marker);
              setTimeout(() => marker.classList.remove("ripple-in"), 300);
            } else if (!this.checked && marker.dataset.labelVisible !== "true") {
              marker.classList.add("ripple-out");
              setTimeout(() => {
                marker.classList.remove("ripple-out");
                marker.style.display = "none";
              }, 300);
            }
          });
          updateArcVisibility();
          setTimeout(() => updateAllDotPositions(), newlyVisible.length ? 300 : 0);
        });
      }

      const toggleCustomEvents = document.getElementById("toggleCustomEvents");
      if (toggleCustomEvents) {
        toggleCustomEvents.addEventListener("change", function() {
          visibilityMap["custom"] = this.checked;
          const markers = clockFace.querySelectorAll(".custom-marker");
          const newlyVisible = [];
          markers.forEach(marker => {
            if (this.checked && marker.dataset.labelVisible !== "true") {
              marker.style.left = marker.dataset.baseLeft;
              marker.style.top = marker.dataset.baseTop;
              marker.style.display = "block";
              marker.classList.add("ripple-in");
              newlyVisible.push(marker);
              setTimeout(() => marker.classList.remove("ripple-in"), 300);
            } else if (!this.checked && marker.dataset.labelVisible !== "true") {
              marker.classList.add("ripple-out");
              setTimeout(() => {
                marker.classList.remove("ripple-out");
                marker.style.display = "none";
              }, 300);
            }
          });
          setTimeout(() => updateAllDotPositions(), newlyVisible.length ? 300 : 0);
        });
      }

      const togglePointer = document.getElementById("togglePointer");
      if (togglePointer) {
        togglePointer.addEventListener("change", function() {
          visibilityMap["pointer"] = this.checked;
          pointer.style.display = this.checked ? "block" : "none";
        });
      }

      const toggleDayTicks = document.getElementById("toggleDayTicks");
      if (toggleDayTicks) {
        toggleDayTicks.addEventListener("change", function() {
          visibilityMap["dayTicks"] = this.checked;
          const N = dayTickElements.length;
          const totalStartSpan = 350;
          if (this.checked) {
            dayTickElements.forEach((tick, index) => {
              const delay = (index / (N - 1)) * totalStartSpan;
              setTimeout(() => {
                const angle = parseFloat(tick.dataset.angle);
                tick.style.transform = `rotate(${angle}deg) scaleY(1) translateZ(0)`;
              }, delay);
            });
          } else {
            dayTickElements.forEach((tick, index) => {
              const delay = (index / (N - 1)) * totalStartSpan;
              setTimeout(() => {
                const angle = parseFloat(tick.dataset.angle);
                tick.style.transform = `rotate(${angle}deg) scaleY(0.83) translateZ(0)`;
              }, delay);
            });
          }
        });
      }

      const toggleFPS = document.getElementById("toggleFPS");
      if (toggleFPS) {
        toggleFPS.addEventListener("change", function() {
          visibilityMap["fps"] = this.checked;
          fpsDisplay.style.display = this.checked ? "block" : "none";
          if (this.checked) requestAnimationFrame(updateFPS);
        });
      }

      const togglePreviewAllDates = document.getElementById("togglePreviewAllDates");
      if (togglePreviewAllDates) {
        togglePreviewAllDates.addEventListener("change", function() {
          visibilityMap["previewAllDates"] = this.checked;
          if (!this.checked) datePreview.classList.remove("visible");
        });
      }

      if (addCustomEventButton) {
        addCustomEventButton.addEventListener("click", () => {
          const name = prompt("Enter event name:");
          const date = prompt("Enter date (MM-DD):");
          if (name && date) {
            const [month, day] = date.split("-").map(Number);
            if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
              const eventId = `custom-${eventCounter++}`;
              const marker = createMarker({ name, month, day }, "custom", eventId);
              events.set(eventId, { type: "custom", name, startMarker: marker });
              const toggle = document.getElementById("toggleCustomEvents");
              if (toggle && !visibilityMap["custom"]) {
                document.getElementById("toggleCustomEventsLabel").style.display = "flex";
                toggle.checked = true;
                visibilityMap["custom"] = true;
              }
              marker.style.display = "block";
              marker.classList.add("ripple-in");
              setTimeout(() => {
                marker.classList.remove("ripple-in");
                updateAllDotPositions();
              }, 300);
            } else {
              alert("Invalid date format!");
            }
          }
        });
      }

      const toggleSeasons = document.getElementById("toggleSeasons");
      if (toggleSeasons) {
        toggleSeasons.addEventListener("change", function() {
          seasonOverlay.style.opacity = this.checked ? "1" : "0";
        });
      }

      const toggleTemperatures = document.getElementById("toggleTemperatures");
      if (toggleTemperatures) {
        toggleTemperatures.addEventListener("change", function() {
          temperatureElements.forEach(temp => temp.classList.toggle("visible", this.checked));
        });
      }

      const toggleClockHands = document.getElementById("toggleClockHands");
      if (toggleClockHands) {
        toggleClockHands.addEventListener("change", function() {
          const hourHand = document.getElementById("hourHand");
          const minuteHand = document.getElementById("minuteHand");
          const secondHand = document.getElementById("secondHand");
          if (hourHand) hourHand.style.display = this.checked ? "block" : "none";
          if (minuteHand) minuteHand.style.display = this.checked ? "block" : "none";
          if (secondHand) secondHand.style.display = this.checked ? "block" : "none";
        });
      }

      if (toggleMoreOptionsButton) {
        toggleMoreOptionsButton.addEventListener("click", function() {
          moreOptionsVisible = !moreOptionsVisible;
          moreOptionsColumn.style.display = moreOptionsVisible ? "flex" : "none";
          toggleMoreOptionsButton.textContent = moreOptionsVisible ? "Hide Options" : "More Options";
        });
      }

      // Zoom with scroll wheel
      clock.addEventListener('wheel', function(e) {
        e.preventDefault();
        const delta = e.deltaY;
        const zoomSpeed = 0.1;
        const oldZ = z;
        z = Math.max(0.5, Math.min(5, z - delta * zoomSpeed)); // Limit zoom between 0.5x and 5x
        const mouseX = e.offsetX;
        const mouseY = e.offsetY;
        const W = 300; // Clock width
        const H = 300; // Clock height
        // Adjust pan to keep the point under the mouse stationary
        panX = mouseX - (z / oldZ) * (mouseX - panX - W / 2) - W / 2;
        panY = mouseY - (z / oldZ) * (mouseY - panY - H / 2) - H / 2;
        clockFace.style.transform = `scale(${z})`;
        clockFace.style.left = `${panX}px`;
        clockFace.style.top = `${panY}px`;
      });

      // Pan with middle mouse button
      clock.addEventListener('mousedown', function(e) {
        if (e.button === 1) { // Middle button
          e.preventDefault();
          isPanning = true;
          startMouseX = e.offsetX;
          startMouseY = e.offsetY;
          startPanX = panX;
          startPanY = panY;
        }
      });

      clock.addEventListener('mousemove', function(e) {
        if (isPanning) {
          const deltaX = e.offsetX - startMouseX;
          const deltaY = e.offsetY - startMouseY;
          panX = startPanX - deltaX / z; // Adjust panning based on zoom level
          panY = startPanY - deltaY / z;
          clockFace.style.left = `${panX}px`;
          clockFace.style.top = `${panY}px`;
        }

        // Existing mousemove logic adjusted for zoom and pan
        const mouseX = e.clientX;
        const mouseY = e.clientY;
        const activeMarker = getClosestMarker(mouseX, mouseY);
        const markers = clockFace.querySelectorAll(".marker");
        markers.forEach(marker => marker.classList.remove("active"));
        events.forEach(event => {
          if (event.arc) event.arc.setAttribute('stroke-width', '2');
        });

        if (visibilityMap["previewAllDates"]) {
          const unscaledX = (e.offsetX - panX) / z;
          const unscaledY = (e.offsetY - panY) / z;
          const dx = unscaledX - 150;
          const dy = unscaledY - 150;
          const distance = Math.sqrt(dx * dx + dy * dy);
          if (distance <= 150) {
            let angleDeg = Math.atan2(dy, dx) * 180 / Math.PI + 90;
            if (angleDeg < 0) angleDeg += 360;
            const monthIndex = Math.floor(angleDeg / 30);
            const month = (monthIndex + 11) % 12 + 1;
            const totalDays = daysInMonth[month - 1];
            const fractionWithinMonth = (angleDeg - (monthIndex * 30)) / 30;
            const day = Math.floor(fractionWithinMonth * totalDays) + 1;
            datePreview.textContent = formatDate(month, day);
            datePreview.classList.add("visible");
          } else {
            datePreview.classList.remove("visible");
          }
        }

        if (activeMarker) {
          const eventId = activeMarker.dataset.eventId;
          if (eventId && events.has(eventId)) {
            const event = events.get(eventId);
            const eventMarkers = [event.startMarker];
            if (event.endMarker) eventMarkers.push(event.endMarker);
            eventMarkers.forEach(m => m.classList.add('active'));
            if (event.endMarker) {
              event.arc.setAttribute('stroke-width', '5');
              const startDate = formatDate(event.startMarker.dataset.month, event.startMarker.dataset.day);
              const endDate = formatDate(event.endMarker.dataset.month, event.endMarker.dataset.day);
              previewWindow.innerHTML = event.name + "<br><span class='event-date'>" + startDate + " <span class='to'>to</span> " + endDate + "</span>";
            } else {
              previewWindow.innerHTML = event.name + "<br><span class='event-date'>" + activeMarker.dataset.date + "</span>";
            }
          } else {
            activeMarker.classList.add("active");
            previewWindow.innerHTML = activeMarker.dataset.name + "<br><span class='event-date'>" + activeMarker.dataset.date + "</span>";
          }
          previewWindow.style.opacity = "1";
        } else if (!previewWindow.style.opacity || previewWindow.style.opacity === "0") {
          previewWindow.style.opacity = "0";
        }
      });

      clock.addEventListener('mouseup', function(e) {
        if (e.button === 1) {
          isPanning = false;
        }
      });

      clock.addEventListener('mouseleave', function() {
        isPanning = false;
      });

      // Marker creation
      function createMarker(data, type, eventId) {
        if (!typePriority.includes(type)) {
          typePriority.push(type);
        }
        const currentYear = new Date().getFullYear();
        const totalDays = new Date(currentYear, data.month, 0).getDate();
        const fraction = (data.day - 1) / totalDays;
        const angle = (data.month - 1 + fraction + 1) * 30;
        const radian = (angle - 90) * Math.PI / 180;
        const baseRadius = 160;
        const markerCenterX = centerX - 10 + baseRadius * Math.cos(radian);
        const markerCenterY = centerY - 10 + baseRadius * Math.sin(radian);
        const container = document.createElement("div");
        container.className = `${type}-marker marker`;
        container.style.left = (markerCenterX - 10) + "px";
        container.style.top = (markerCenterY - 10) + "px";
        container.dataset.name = data.name;
        container.dataset.date = formatDate(data.month, data.day);
        container.dataset.month = data.month;
        container.dataset.day = data.day;
        container.dataset.year = data.year || "";
        container.dataset.type = type;
        container.dataset.order = Date.now();
        container.dataset.baseLeft = (markerCenterX - 10) + "px";
        container.dataset.baseTop = (markerCenterY - 10) + "px";
        container.dataset.angle = angle;
        if (eventId) container.dataset.eventId = eventId;
        container.style.display = "none";
        const dot = document.createElement("div");
        dot.className = `${type}-dot`;
        if (data.color) dot.style.backgroundColor = data.color;
        container.appendChild(dot);
        clockFace.appendChild(container);
        return container;
      }

      function getClosestMarker(x, y) {
        let activeMarker = null;
        let minDistance = Infinity;
        const markers = clockFace.querySelectorAll(".marker");
        markers.forEach(marker => {
          if (getComputedStyle(marker).display !== "none") {
            const rect = marker.getBoundingClientRect();
            const markerCenterX = rect.left + rect.width / 2;
            const markerCenterY = rect.top + rect.height / 2;
            const distance = Math.sqrt(Math.pow(x - markerCenterX, 2) + Math.pow(y - markerCenterY, 2));
            if (distance < triggerRadius && distance < minDistance) {
              minDistance = distance;
              activeMarker = marker;
            }
          }
        });
        return activeMarker;
      }

      // Placeholder functions (to be implemented as needed)
      function updateAllDotPositions() {
        // Implementation for updating marker positions if needed
      }

      function updateArcVisibility() {
        // Implementation for updating arc visibility if needed
      }

      // Initial setup calls can be added here if needed
    });
  </script>
</body>
</html>
